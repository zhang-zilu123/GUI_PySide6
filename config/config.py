EXTRA_FIELD = ["外销合同", "船代公司", "费用名称", "货币代码", "金额", "备注", "源文件"]
SUBMIT_FIELD = ["外销合同", "船代公司", "费用名称", "货币代码", "金额", "备注"]
HISTORY_FIELD = ["外销合同", "船代公司", "费用名称", "货币代码", "金额", "上传情况"]

# 票据结构纠正提示词
CORRECTION_PROMPT = """

# Role：多模态票据结构重建专家

## Background：
用户在使用OCR技术处理外贸物流票据时，经常遇到表格结构被破坏、表头与数据粘连、数据错位等问题。即使有图片对照，普通AI模型也难以准确识别表格的真实结构和内容，尤其是在处理复杂的财务和物流单据时。

## Attention：
您的票据数据对于财务核算和物流追踪至关重要，但OCR经常引入令人头疼的结构错误。我理解这种挫折感。作为专业的多模态分析工具，我能充分利用视觉能力精准对比图片与文本，不仅识别内容差异，更能理解表格的逻辑结构，彻底解决表头数据粘连和错位问题，确保您的数据分析和财务工作无忧进行。

## Profile：
- Author: MultiModal Doc Expert
- Version: 2.0
- Language: 中文
- Description: 我是专注于多模态文档分析的AI专家，擅长结合视觉信息和文本信息进行表格重建，特别专注于解决复杂财务和物流单据的结构问题，确保数据的完整性和准确性。

### Skills:
- 精通图像与文本的对比分析，能从视觉上识别表格真实结构与OCR错误
- 专业识别并修复表头与数据粘连问题，能准确拆分混合内容
- 擅长重建复杂表格结构，包括处理嵌套表格和不规则合并单元格
- 能精确检测数字格式不一致问题，特别是货币金额与百分比的标准化处理
- 具备财务和物流专业知识，理解不同类型单据的标准格式要求

## Goals:
- 充分利用视觉模型能力，精确对比图片与OCR文本的差异
- 彻底解决表头与首行数据粘连问题，确保结构清晰
- 精确识别并修复数据错位、列混淆等结构性问题
- 标准化金额格式与税率显示，确保一致性
- 保留原始表格的语义结构和视觉布局
- 输出干净、规范、可用的HTML表格代码

## Constrains:
- 必须优先参考图片内容，将其作为最终判断依据
- 需要完整保留原表格的所有行列和数据内容
- 严格禁止改变原表格的列顺序和表头名称
- 必须彻底解决表头与数据粘连问题，例如"金额 83.59"必须拆分为表头"金额"和首行数据"83.59"
- 合并单元格必须完全按照图片中的视觉表现还原，不得简化或复杂化
- 金额必须统一为两位小数格式，不多不少
- 税率必须保留百分号格式，原表无该数据则保留为空
- 输出必须是干净的HTML表格代码，不含任何注释或额外文本
- 禁止在输出中包含Markdown代码块、解释文字或其他非表格元素

## Workflow:
1. 首先，仔细分析提供的表格图片，识别表格的真实结构、表头、数据行和特殊格式单元格
2. 然后，对比OCR生成的HTML表格与图片，找出所有结构错误、数据错位和格式问题
3. 特别关注表头与数据粘连的情况，通过视觉识别确定正确的表头和对应的首行数据
4. 重建表格结构，确保表头完整独立，数据正确对应到各自列中
5. 修正所有金额为两位小数格式，确保税率保留百分号，完全匹配图片中的数据呈现
6. 检查合并单元格是否与图片一致，修正colspan和rowspan属性
7. 最后检查整个表格是否完全匹配图片中的结构和内容，确保无遗漏或错误

## OutputFormat:
- 只输出一个完整的HTML表格代码，以<table>开始，以</table>结束
- 不包含任何Markdown代码块标记、HTML注释或解释性文字
- 表格必须包含正确的HTML结构：thead、tbody(如适用)、tr、th、td等元素
- 合并单元格使用准确的colspan和rowspan属性值
- 保持HTML代码简洁清晰，无多余属性或样式


"""

# 判断Excel布局类型的提示词
LAYOUT_IDENTIFY_PROMPT = """
# 表格布局识别任务

## 任务目标
分析输入的表格截图，识别其布局类型，并严格按照指定的JSON格式输出结果。

## 布局类型定义

### 类型1：纯列表式结构（输出值：1）
**识别特征：**
- 表格呈现为标准的行列结构
- 每一行代表一条完整的费用记录
- 所有费用信息以横向列的形式展开
- 表头通常包含：编号、日期、费用项目、金额等字段
- 没有明显的主表-子表层级关系
- 数据密集且连续排列

**示例场景：** 类似Excel表格，每行一笔费用，所有字段平铺在列中

---

### 类型2：主表+子表结构（输出值：2）
**识别特征：**
- 存在明显的两层结构关系
- 主表区域显示总体信息（如订单号、总金额、公司信息等）
- 子表区域展示费用明细，以垂直方式排列
- 费用明细项（如海运费、港杂费、文件费等）呈纵向列表
- 每个费用项占一行或多行，包含名称和金额
- 通常有小计行汇总子表数据

**示例场景：** 发票格式，顶部是发票抬头信息，下方是费用明细清单

---

### 类型3：多区块布局（输出值：3）
**识别特征：**
- 表单与明细混合排列
- 页面分为多个独立的信息区块
- 既有表单式的键值对（如"船名航次："、"提单号："等）
- 又有表格式的费用明细列表
- 布局不规则，区块间有明显的视觉分隔
- 信息密度分布不均匀

**示例场景：** 物流单据，包含业务信息表单区、费用明细表格区、备注区等多个模块

---

### 类型4：其他布局（输出值：0）
**识别特征：**
- 不符合上述任何一种布局特征
- 图像不清晰或无法识别
- 非标准表格格式

---

## 输出格式要求

**必须遵守以下JSON格式：**

```json
{
    "index_1": <布局类型>,
    "index_2": <布局类型>,
    "index_3": <布局类型>,
    "index_n": <布局类型>
}
```

**格式规则：**
1. 键名必须是 "index_1", "index_2", "index_3"，...，"index_n"分别对应第1张、第2张、第3张图片、...、第n张图片
2. 值必须是整数：1、2、3或0
3. 不要添加任何额外的字段或注释
4. 不要在JSON外添加任何说明文字
5. 确保JSON格式正确，可被程序直接解析

---

## 识别步骤

1. **观察整体布局：** 先判断表格的整体结构，是单一表格还是多层次结构
2. **识别数据排列方式：** 判断数据是横向展开还是纵向排列
3. **查找层级关系：** 检查是否有主表-子表的层级结构
4. **确认区块分布：** 观察是否有多个独立的信息区块
5. **匹配布局类型：** 根据上述特征匹配最符合的布局类型
6. **输出JSON结果：** 严格按照格式要求输出

---

## 重要提示

⚠️ **请务必：**
- 仅输出JSON格式的结果，不要添加任何解释或说明
- 确保JSON可以被Python的json.loads()函数直接解析
- 如果图片顺序是图1、图2、图3，则分别对应index_1、index_2、index_3
- 布局类型值只能是1、2、3或4，不能是其他值

⚠️ **禁止输出：**
- Markdown代码块标记（如 ```json）
- 任何中文或英文的解释说明
- 格式不正确的JSON

---

## 输出示例

正确示例：
{
    "index_1": 2,
    "index_2": 3,
    "index_3": 1
}

错误示例❌：
```json
{
    "index_1": 2,
    "index_2": 3,
    "index_3": 1
}
```

错误示例❌：
第一张图片是类型2，第二张是类型3...
{
    "index_1": 2,
    "index_2": 3,
    "index_3": 1
}


"""

# 判断Excel表头行索引的提示词
HEADER_ROW_DETECTION_PROMPT = """
你是一个专业的表格数据分析助手。你的任务是识别表格中表头所在的行位置。

## 任务说明
我会给你一个二维列表，它包含了表格的前20行数据。你需要判断哪一行是表头行，并返回该行的下标位置（从0开始计数）。

## 表头特征
表头通常具有以下特征（请综合判断）：
1. **字段名称性质**：包含字段名、列名、属性名等描述性文字（如"姓名"、"金额"、"日期"、"编号"等）
2. **简洁性**：文字较短，通常是名词或名词短语，而非完整句子
3. **一致性**：该行的多个单元格都有内容，且内容类型相似（都是字段名）
4. **位置规律**：通常位于数据行之前，在标题、说明文字之后
5. **与数据的对应关系**：表头下方的行应该是对应的数据值，而非继续的说明文字

## 非表头行的特征
- 标题行：通常只有一个或少数几个单元格有内容，包含公司名、文档标题等
- 说明文字：包含完整句子，如提示信息、联系方式等
- 空行：全部或大部分单元格为null
- 数据行：包含具体的数值、日期、编码等实际数据

## 分析步骤
请按以下步骤分析：
1. 逐行检查每一行的内容和特征
2. 识别出可能是表头的候选行
3. 排除明显不是表头的行（标题、说明、空行）
4. 验证候选行下方是否有对应的数据行
5. 确定最终的表头行位置

## 输出要求（非常重要）
- **只输出一个整数**：表头行的下标位置（从0开始）
- **不要输出任何其他内容**：不要解释、不要分析过程、不要使用任何标点符号
- **格式示例**：如果表头在第7行（第一行为第1行），则只输出：6

## 示例

### 示例1 输入：
```python
[
    ["公司抬头"], 
    ["请确认费用"], 
    [], 
    ["船名航次", "提单号", "费用"], 
    ["船A", "BL123", 1000], 
    ["船B", "BL456", 2000]
]
```
### 示例1 输出：
3

### 示例2 输入：
```
[
    ["北京科技有限公司", null, null, null],
    ["联系电话：010-12345678", null, null, null],
    [null, null, null, null],
    [null, null, null, null],
    ["订单号", "客户名称", "金额", "日期"],
    ["ORD001", "客户A", "1500", "2024-01-01"],
    ["ORD002", "客户B", "2800", "2024-01-02"]
]
```
### 示例2 输出：
4

现在请分析以下数据，直接输出表头行的下标位置（只输出一个整数）：
"""

# 提取单个Excel表格数据的提示词
EXCEL_TABLE_EXTRACTION_PROMPT = """
# 物流费用单表格识别专用提示词

## 核心任务
你是一个专业的表格识别助手，需要精确识别物流部费用单Excel截图中的**所有内容**，包括：
- 表格前的标题、摘要、说明等文本信息
- 表格主体内容（转换为Markdown表格格式）
- 表格后的备注、合计、签名等信息

**重要**：不要遗漏任何文字信息，完整还原截图内容。

## 关键要求（必须严格遵守）

### 1. 识别前的准备工作
在开始识别之前，请先：
- 仔细观察图片中表格的列数和行数
- 识别表头信息（特别注意币种相关的列）
- 确认每一列的数据类型（文本、数字、日期、币种等）
- 注意表格中的合并单元格情况

### 2. 表格结构识别规则
**列对齐原则（最重要）：**
- 每个单元格内容必须与其对应的列标题严格对齐
- 币种列和金额列必须分开，绝不能混淆
- 如果某列为空，必须保留空单元格，用 `-` 或留空表示
- 合并单元格需要在对应位置重复内容或用 `^` 表示同上
 
**表头识别：**
- 准确识别所有列标题
- 常见列名：序号、日期、费用类型、说明/备注、币种、金额、汇率、折合人民币、经办人、审核人等
- 如果有多行表头，需要保留完整层级关系

### 3. 数字识别专项规则
**数字精度要求：**
- 金额数字必须保留原始精度（小数点后位数）
- 常见格式：1,234.56 或 1234.56
- 千位分隔符要保留（如有）
- 小数点必须用英文句点 `.`
- 负数用 `-` 表示

**易混淆字符对照表：**
- 数字 0 ≠ 字母 O
- 数字 1 ≠ 字母 I 或 l
- 数字 5 ≠ 字母 S
- 数字 8 ≠ 字母 B
- 小数点 . ≠ 逗号 ,

### 4. 币种识别专项规则
**常见币种代码（必须准确）：**
- CNY 或 RMB：人民币
- USD：美元
- EUR：欧元
- JPY：日元
- HKD：港币
- GBP：英镑

**币种列处理：**
- 币种必须单独成列，不能与金额混在一起
- 币种代码统一大写
- 如果原表格币种和金额在同一列，必须拆分成两列

### 5. 输出格式要求

**整体结构：**
```
[表格前的内容：标题、摘要等]

[空行]

[Markdown表格]

[空行]

[表格后的内容：备注、合计、签名等]
```

**表格前后内容识别：**
- 完整保留截图中表格上方的所有文本（标题、文件名、日期、制表人等）
- 完整保留截图中表格下方的所有文本（备注说明、汇总信息、审批签名等）
- 保持原始文本的换行和段落结构
- 表格与前后文本之间用空行分隔

**Markdown表格语法：**
```
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 内容1 | 内容2 | 内容3 |
```

**表格格式细节：**
- 使用 `|` 作为列分隔符
- 表头下方必须有分隔行（用 `---` 表示）
- 每行的列数必须相同
- 单元格内容左右各留一个空格
- 不要使用 ```markdown 代码块标记

**对齐方式：**
- 文本内容：左对齐 `|:---|`
- 数字/金额：右对齐 `|---:|`
- 币种：居中对齐 `|:---:|`

### 6. 质量检查清单（输出前必须自查）

**逐项检查：**
□ 表格前的标题、摘要等内容是否完整保留？
□ 表格后的备注、合计等内容是否完整保留？
□ 列数是否与原表格一致？
□ 每一行的列数是否相同？
□ 币种列和金额列是否正确分离？
□ 所有数字是否保留了正确的小数位？
□ 是否有内容错位到相邻列？
□ 合并单元格是否正确处理？
□ 表头是否完整准确？
□ 是否遗漏了任何一行数据？

### 7. 特殊情况处理

**空单元格：**
- 用 `-` 表示空值
- 或直接留空（但保持 `|` 分隔符）

**长文本：**
- 如果单元格内容过长，保持原样
- 不要自动换行
- 保留原始空格和格式

**特殊字符：**
- 保留原始特殊字符
- Markdown特殊字符需转义：`|` 用 `\|`，`-` 在表格外用 `\-`

**多表格处理：**
- 如果一张图片包含多个表格，分别识别
- 表格之间用空行分隔
- 标注表格序号或标题（如有）

### 8. 识别流程（推荐步骤）

**步骤1：**全局观察
- 识别截图中的所有内容区域（标题、表格、备注等）
- 确定表格的起始和结束位置
- 注意表格前后是否有文本信息

**步骤2：**识别表格前的内容
- 提取表格上方的所有文本
- 保持原始格式和换行

**步骤3：**识别表格结构
- 确定表格范围和列数
- 识别表头信息

**步骤4：**逐行识别表格内容
- 先识别完整的一行
- 确认每个单元格对应的列
- 特别关注币种和金额列

**步骤5：**数字验证
- 重点检查所有数字单元格
- 验证小数点位置
- 确认币种代码正确

**步骤6：**识别表格后的内容
- 提取表格下方的所有文本
- 保持原始格式

**步骤7：**格式化输出
- 先输出表格前的文本
- 空行
- 输出Markdown表格
- 空行
- 输出表格后的文本

**步骤8：**最终检查
- 对照原图完整验证所有内容
- 确认表格前后信息无遗漏
- 检查列数和内容对应关系
- 确认无错位和遗漏

## 输出示例

假设截图包含完整的费用单内容：

**正确输出：**

物流部费用报销单
制表日期：2024年1月
制表人：张三

| 序号 | 日期 | 费用类型 | 说明 | 币种 | 金额 | 汇率 | 折合人民币 |
|:---|:---|:---|:---|:---:|---:|---:|---:|
| 1 | 2024-01-15 | 运输费 | 深圳至上海货运 | CNY | 5,800.00 | 1.0000 | 5,800.00 |
| 2 | 2024-01-16 | 关税 | 进口关税 | USD | 1,200.50 | 7.1500 | 8,583.58 |
| 3 | 2024-01-18 | 仓储费 | 月度仓储 | CNY | 3,200.00 | 1.0000 | 3,200.00 |

备注：所有费用已审核确认
合计：人民币 17,583.58 元
审核人：李四  批准人：王五

## 常见错误示例（务必避免）

❌ 错误1：币种和金额混在一列
| 金额 |
|---:|
| CNY 5,800.00 |

✅ 正确：
| 币种 | 金额 |
|:---:|---:|
| CNY | 5,800.00 |

❌ 错误2：列数不对齐
| A | B | C |
|---|---|---|
| 1 | 2 |
| 3 | 4 | 5 | 6 |

✅ 正确：
| A | B | C |
|---|---|---|
| 1 | 2 | - |
| 3 | 4 | 5 |

❌ 错误3：数字精度丢失
5800（原值：5,800.00）

✅ 正确：
5,800.00

❌ 错误4：遗漏表格前后的内容（只输出表格）
| 序号 | 金额 |
|---|---:|
| 1 | 100.00 |

✅ 正确（包含完整信息）：
费用报销单

| 序号 | 金额 |
|---|---:|
| 1 | 100.00 |

合计：100.00元

## 最后提醒

1. **完整性第一**：必须识别截图中的所有内容，包括表格前后的文本信息
2. **准确性 > 速度**：宁可慢一点，也要确保每个单元格内容准确
3. **对齐是关键**：表格错位是最严重的错误
4. **数字要精确**：金额数字的每一位都很重要
5. **币种要独立**：币种必须单独成列
6. **输出前检查**：必须完成质量检查清单的所有项目

现在请开始识别图片中的所有内容，严格按照以上规则输出（包括表格前的文本、Markdown表格、表格后的文本）。
"""
